<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        body {
            background-color: #fbf6ec;
        }
    </style>
</head>
<body>
    <h1>Wikia Graphs</h1>
    <div id="mdw-types-chart"></div>
    <hr />
    <div id="mdw-cardsbycolor-chart"></div>
    <hr />
    <div id="mdw-manacurve-chart"></div>
    <hr />
    <div id="test-chart"></div>
    <div id="mdw-chartdata" style="display:none" data-chart="&#91;&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:1},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:4},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;,&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Artifact&quot;],&quot;num&quot;:2,&quot;cmc&quot;:3},&#123;&quot;num&quot;:4,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:13,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]}]"></div>
    <div id="mdw-chartdata-1" style="display:none" data-chart="&#91;&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:1},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:1},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;,&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:5},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:5},&#123;&quot;types&quot;:&#91;&quot;Planeswalker&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:6},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:8},&#123;&quot;num&quot;:7,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:9,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:1,&quot;types&quot;:&#91;&quot;Land&quot;]}]"></div>
    <hr />
    <textarea id="jsondata" cols="40" rows="30"></textarea>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
    </script>
    <script>

        (function () {
            var dataString = $("#mdw-chartdata").attr("data-chart");
            var json = JSON.parse(dataString);
            var jsonString = JSON.stringify(json, null, 4);
            $("#jsondata").html(jsonString);
        })();

        function drawTestChart() {
            var stroke = "stroke-color: #000000;"
            // Define the chart to be drawn.
            var data = google.visualization.arrayToDataTable([
               ['Year', 'Asia', { role: 'style' }, 'Europe', { role: 'style' }],
               ['2012', 900, stroke, 390, stroke],
               ['2013', 1000, stroke, 400, stroke],
               ['2014', 1170, stroke, null, stroke],
               ['2015', 500, stroke, 0, stroke],
               ['2016', null, stroke, 540, stroke]
            ]);

            var options = {
                title: 'Population (in millions)',
                isStacked: true,
                colors: ['red','white'],
            };

            // Instantiate and draw the chart.
            var chart = new google.visualization.ColumnChart(document.getElementById('test-chart'));
            chart.draw(data, options);
        }

        // Start: graphs
        (function ($) {

            function getChartColor(dataColor) {
                var colors = {
                    Red: '#f28f78',
                    Green: '#7dcd98',
                    Blue: '#92d4f7',
                    White: '#ffffd9',
                    Black: '#515151',
                    Multicolored: '#ffd778',
                    Colorless: '#abafb0',
                };
                return colors[dataColor];
            }

            function getCardTypeColor(type) {
                var colors = {
                    Land: 'grey',
                    Creature: 'grey',
                    Artifact: 'grey',
                    Enchantment: 'grey',
                    Instant: 'grey',
                    Sorcery: 'grey',
                    Planeswalker: 'grey',
                };
                return colors[type];
            }

            var chartDataId = "mdw-chartdata";
            var colorPieChartId = "mdw-cardsbycolor-chart";
            var manaCurveChartId = "mdw-manacurve-chart";
            var typesPieChartId = "mdw-types-chart";

            var dataIndex = {
                color: 0,
                num: 1,
                cmc: 2,
                type: 0
            }

            var dataCache = {
                colorPie: {
                    data: null,
                    colors: null
                },
                manaCurve: {
                    data: null,
                    colors: null
                },
                typesPie: {
                    data: null,
                    colors: null
                }
            }

            function hasColorPieChart() {
                return document.getElementById(colorPieChartId) !== null;
            }

            function hasManaCurveChart() {
                return document.getElementById(manaCurveChartId) !== null;
            }

            function hasTypesPieChart() {
                return document.getElementById(typesPieChartId) !== null;
            }

            function hasCharts() {
                if (document.getElementById(chartDataId) === null)
                    return false;
                return hasColorPieChart()
                    || hasManaCurveChart()
                    || hasTypesPieChart();
            }

            function isLand(card) {
                return $.inArray("Land", card.types) !== -1;
            }

            function adjustedColor(colors) {
                if (colors === undefined || colors.length === 0)
                    return "Colorless";
                if (colors.length > 1)
                    return "Multicolored";
                return colors[0];
            }

            function addCalculatedFieldsToData(cardData) {
                cardData.forEach(function (card) {
                    card.isLand = isLand(card);
                    if (!card.isLand)
                        card.adjustedColor = adjustedColor(card.colors);
                });
                return cardData;
            }

            function getChartData() {
                var dataString = document.getElementById(chartDataId).getAttribute("data-chart");
                var cardData = JSON.parse(dataString);
                return addCalculatedFieldsToData(cardData);
            }

            function getColorOnlyData(cardData) {
                var colorData = [];
                cardData.forEach(function (card) {
                    if (!card.isLand)
                        colorData.push([card.adjustedColor, card.num]);
                });
                colorData.sort(function (a, b) {
                    return a[dataIndex.color].localeCompare(b[dataIndex.color]);
                });
                return colorData;
            }

            function getCardTypeData(cardData) {
                var typeData = [];
                cardData.forEach(function (card) {
                    card.types.forEach(function (type) {
                        typeData.push([type, card.num]);
                    });
                });
                typeData.sort(function (a, b) {
                    return a[dataIndex.type].localeCompare(b[dataIndex.type]);
                });
                return typeData;
            }

            function sumByType(data) {
                var summedData = [];
                if (data.length === 0)
                    return summedData;
                summedData.push(data[0]);
                for (var k = 1; k < data.length; k++) {
                    var lastIndex = summedData.length - 1;
                    if (data[k][dataIndex.type] === summedData[lastIndex][dataIndex.type])
                        summedData[lastIndex][dataIndex.num] += data[k][dataIndex.num];
                    else
                        summedData.push(data[k]);
                }
                return summedData;
            }
            
            function getColorWithCostData(cardData) {
                var colorData = [];
                cardData.forEach(function (card) {
                    if (!card.isLand)
                        colorData.push([card.adjustedColor, card.num, card.cmc]);
                });
                // order by color then by cmc
                colorData.sort(function (a, b) {
                    var colorCompare = a[dataIndex.color].localeCompare(b[dataIndex.color]);
                    if (colorCompare != 0)
                        return colorCompare;
                    var aCmc = a[dataIndex.cmc];
                    var bCmc = b[dataIndex.cmc];
                    if (aCmc < bCmc)
                        return -1;
                    if (aCmc > bCmc)
                        return 1;
                    return 0;
                });
                return colorData;
            }

            function sumByColor(data) {
                var summedData = [];
                if (data.length === 0)
                    return summedData;
                summedData.push(data[0]);
                for (var k = 1; k < data.length; k++) {
                    var lastIndex = summedData.length - 1;
                    if (data[k][dataIndex.color] === summedData[lastIndex][dataIndex.color])
                        summedData[lastIndex][dataIndex.num] += data[k][dataIndex.num];
                    else
                        summedData.push(data[k]);
                }
                return summedData;
            }

            function sumByColorAndCost(data) {
                var summedData = [];
                if (data.length === 0)
                    return summedData;
                summedData.push(data[0]);
                for (var k = 1; k < data.length; k++) {
                    var lastIndex = summedData.length - 1;
                    if (data[k][dataIndex.color] === summedData[lastIndex][dataIndex.color]
                            && data[k][dataIndex.cmc] === summedData[lastIndex][dataIndex.cmc])
                        summedData[lastIndex][1] += data[k][1];
                    else
                        summedData.push(data[k]);
                }
                return summedData;
            }

            function cacheColorPieData(cardData) {
                var rawData = getColorOnlyData(cardData);
                var summedData = sumByColor(rawData);

                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Color');
                dataTable.addColumn('number', 'Number');
                dataTable.addRows(summedData);

                var sliceColors = [];
                summedData.forEach(function (e) {
                    sliceColors.push(getChartColor(e[dataIndex.color]));
                });

                dataCache.colorPie.data = dataTable;
                dataCache.colorPie.colors = sliceColors;
            }

            function drawColorPieChart() {
                var options = {
                    height: 240,
                    colors: dataCache.colorPie.colors,
                    pieSliceText: 'value',
                    pieSliceBorderColor: "black",
                    pieSliceTextStyle: {
                        color: 'black',
                        bold: true
                    },
                    backgroundColor: {
                        fill: 'transparent'
                    },
                    legend: {
                        textStyle: {
                            color: 'black'
                        }
                    },
                };
                var chart = new google.visualization.PieChart(document.getElementById(colorPieChartId));
                chart.draw(dataCache.colorPie.data, options);
            }

            function MakeLabelsForManaCurve(chartData) {
                var labels = ['Cost'];
                var k = 0;
                while (k < chartData.length) {
                    var color = chartData[k++][dataIndex.color];
                    labels.push(color);
                    while (k < chartData.length && chartData[k][dataIndex.color] === color)
                        ++k;
                }
                return labels;
            }

            function formatDataForManaCurveChart(chartData) {
                var labels = MakeLabelsForManaCurve(chartData);
                var numColumns = labels.length;

                var data = [labels];
                for (var k = 0; k < 7; k++) {
                    var dataline = new Array(numColumns);
                    dataline[0] = k.toString();
                    for (var k2 = 1; k2 < numColumns; k2++)
                        dataline[k2] = 0;
                    data.push(dataline);
                }
                data[7][0] = "6+";

                var index = 1;
                var color = chartData[0][dataIndex.color];
                chartData.forEach(function (row) {
                    if (color != row[dataIndex.color]) {
                        ++index;
                        color = row[dataIndex.color];
                    }
                    var cmc = Math.min(row[dataIndex.cmc], 6);
                    data[cmc + 1][index] += row[dataIndex.num];
                });

                for (var seriesIndex = 1; seriesIndex < data.length; seriesIndex++) {
                    series = data[seriesIndex];
                    for (var itemIndex = 1; itemIndex < series.length; itemIndex++) {
                        if (series[itemIndex] === 0)
                            series[itemIndex] = null;
                    }
                }

                return data;
            }

            function cacheManaCurveData(data) {
                var rawData = getColorWithCostData(data);
                var summedData = sumByColorAndCost(rawData);
                var formattedData = formatDataForManaCurveChart(summedData);

                var sectionColors = [];
                for (var k = 1; k < formattedData[0].length; k++)
                    sectionColors.push(getChartColor(formattedData[0][k]));

                dataCache.manaCurve.data = google.visualization.arrayToDataTable(formattedData);
                dataCache.manaCurve.colors = sectionColors;
            }

            function drawManaCurveChart() {
                var options = {
                    legend: {
                        position: 'top',
                        maxLines: 3
                    },
                    bar: {
                        groupWidth: '80%'
                    },
                    isStacked: true,
                    backgroundColor: {
                        fill: 'transparent'
                    },
                    colors: dataCache.manaCurve.colors
                };
                var chart = new google.visualization.ColumnChart(document.getElementById(manaCurveChartId));
                chart.draw(dataCache.manaCurve.data, options);
            }

            function cacheTypesPieData(cardData) {
                var rawData = getCardTypeData(cardData);
                var summedData = sumByType(rawData);

                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Color');
                dataTable.addColumn('number', 'Number');
                dataTable.addRows(summedData);

                var sliceColors = [];
                summedData.forEach(function (e) {
                    sliceColors.push(getCardTypeColor(e[dataIndex.type]));
                });

                dataCache.typesPie.data = dataTable;
                dataCache.typesPie.colors = sliceColors;
            }

            function drawTypesPieChart() {
                var options = {
                    height: 340,
                    colors: dataCache.typesPie.colors,
                    pieSliceText: 'value',
                    pieSliceBorderColor: "black",
                    pieSliceTextStyle: {
                        color: 'black',
                        bold: true
                    },
                    backgroundColor: {
                        fill: 'transparent'
                    },
                    legend: {
                        textStyle: {
                            color: 'black'
                        },
                        position: 'labeled'
                    },
                };
                var chart = new google.visualization.PieChart(document.getElementById(typesPieChartId));
                chart.draw(dataCache.typesPie.data, options);

            }

            function drawAllCharts() {
                if (hasColorPieChart())
                    drawColorPieChart();
                if (hasManaCurveChart())
                    drawManaCurveChart();
                if (hasTypesPieChart())
                    drawTypesPieChart();
            }

            function chartLibraryLoaded() {
                var chartData = getChartData();
                cacheColorPieData(chartData);
                cacheManaCurveData(chartData);
                cacheTypesPieData(chartData);
                drawAllCharts();
                $(window).resize(drawAllCharts);
            }

            // do nothing for a page with no charts
            if (!hasCharts())
                return;

            $.getScript('https://www.gstatic.com/charts/loader.js', function () {
                google.charts.load('current', { 'packages': ['corechart'] });
                google.charts.setOnLoadCallback(chartLibraryLoaded);
            });

        })(jQuery);
        // End: graphs

    </script>
</body>
</html>