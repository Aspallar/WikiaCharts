<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        body {
            background-color: #fbf6ec;
        }
    </style>
</head>
<body>
    <h1>Wikia Graphs</h1>
    <div id="mdw-cardsbycolor-chart"></div>
    <hr />
    <div id="mdw-manacurve-chart"></div>
    <hr />
    <div id="test-chart"></div>
    <div id="mdw-chartdata" style="display:none" data-chart="&#91;&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:1},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:1},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:2},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;,&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Enchantment&quot;],&quot;num&quot;:3,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Instant&quot;],&quot;num&quot;:4,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:3},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:2,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:5},&#123;&quot;types&quot;:&#91;&quot;Sorcery&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Blue&quot;],&quot;cmc&quot;:5},&#123;&quot;types&quot;:&#91;&quot;Planeswalker&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:6},&#123;&quot;types&quot;:&#91;&quot;Creature&quot;],&quot;num&quot;:1,&quot;colors&quot;:&#91;&quot;Red&quot;],&quot;cmc&quot;:8},&#123;&quot;num&quot;:7,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:9,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:2,&quot;types&quot;:&#91;&quot;Land&quot;]},&#123;&quot;num&quot;:1,&quot;types&quot;:&#91;&quot;Land&quot;]}]"></div>
    <hr />
    <textarea id="jsondata" cols="40" rows="30"></textarea>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
    </script>
    <script>

        (function () {
            var dataString = $("#mdw-chartdata").attr("data-chart");
            var json = JSON.parse(dataString);
            var jsonString = JSON.stringify(json, null, 4);
            $("#jsondata").html(jsonString);
        })();

        function drawTestChart() {
            var stroke = "stroke-color: #000000;"
            // Define the chart to be drawn.
            var data = google.visualization.arrayToDataTable([
               ['Year', 'Asia', { role: 'style' }, 'Europe', { role: 'style' }],
               ['2012', 900, stroke, 390, stroke],
               ['2013', 1000, stroke, 400, stroke],
               ['2014', 1170, stroke, null, stroke],
               ['2015', 500, stroke, 0, stroke],
               ['2016', null, stroke, 540, stroke]
            ]);

            var options = {
                title: 'Population (in millions)',
                isStacked: true,
                colors: ['red','white'],
            };

            // Instantiate and draw the chart.
            var chart = new google.visualization.ColumnChart(document.getElementById('test-chart'));
            chart.draw(data, options);
        }

        // Start: graphs
        (function () {

            var chartDataId = "mdw-chartdata";
            var colorPieChartId = "mdw-cardsbycolor-chart";
            var manaCurveChartId = "mdw-manacurve-chart";

            var colorIndex = 0;
            var numIndex = 1;
            var cmcIndex = 2;

            function hasColorPieChart() {
                return document.getElementById(colorPieChartId) !== null;
            }

            function hasManaCurveChart() {
                return document.getElementById(manaCurveChartId) !== null;
            }

            function hasCharts() {
                if (document.getElementById(chartDataId) === null)
                    return false;
                return hasColorPieChart() || hasManaCurveChart();
            }

            function isLand(card) {
                return jQuery.inArray("Land", card.types) !== -1;
            }

            function adjustedColor(colors) {
                if (colors === undefined || colors.length === 0)
                    return "Colorless";
                if (colors.length > 1)
                    return "Multicolored";
                return colors[0];
            }

            function addCalculatedFieldsToData(cardData) {
                cardData.forEach(function (card) {
                    card.isLand = isLand(card);
                    if (!card.isLand)
                        card.adjustedColor = adjustedColor(card.colors);
                });
                return cardData;
            }

            function getChartData() {
                var dataString = document.getElementById(chartDataId).getAttribute("data-chart");
                var cardData = JSON.parse(dataString);
                return addCalculatedFieldsToData(cardData);
            }

            function getColorOnlyData(cardData) {
                var colorData = [];
                cardData.forEach(function (card) {
                    if (!card.isLand)
                        colorData.push([card.adjustedColor, card.num]);
                });
                colorData.sort(function (a, b) {
                    return a[colorIndex].localeCompare(b[colorIndex]);
                });
                return colorData;
            }

            function getColorWithCostData(cardData) {
                var colorData = [];
                cardData.forEach(function (card) {
                    if (!card.isLand)
                        colorData.push([card.adjustedColor, card.num, card.cmc]);
                });
                colorData.sort(function (a, b) {
                    var colorCompare = a[colorIndex].localeCompare(b[colorIndex]);
                    if (colorCompare != 0)
                        return colorCompare;
                    var aCmc = a[cmcIndex];
                    var bCmc = b[cmcIndex];
                    if (aCmc < bCmc)
                        return -1;
                    if (aCmc > bCmc)
                        return 1;
                    return 0;
                });
                return colorData;
            }

            function sumByColor(data) {
                var summedData = [];
                if (data.length === 0)
                    return summedData;
                summedData.push(data[0]);
                for (var k = 1; k < data.length; k++) {
                    var lastIndex = summedData.length - 1;
                    if (data[k][colorIndex] === summedData[lastIndex][colorIndex])
                        summedData[lastIndex][numIndex] += data[k][numIndex];
                    else
                        summedData.push(data[k]);
                }
                return summedData;
            }

            function sumByColorAndCost(data) {
                var summedData = [];
                if (data.length === 0)
                    return summedData;
                summedData.push(data[0]);
                for (var k = 1; k < data.length; k++) {
                    var lastIndex = summedData.length - 1;
                    if (data[k][colorIndex] === summedData[lastIndex][colorIndex]
                            && data[k][cmcIndex] === summedData[lastIndex][cmcIndex])
                        summedData[lastIndex][1] += data[k][1];
                    else
                        summedData.push(data[k]);
                }
                return summedData;
            }

            function getChartColor(dataColor) {
                var colors = {
                    Red: '#f28f78',
                    Green: '#7dcd98',
                    Blue: '#92d4f7',
                    White: '#ffffd9',
                    Black: '#515151',
                    Multicolored: '#ffd778',
                    Colorless: '#abafb0',
                };
                return colors[dataColor];
            }

            function drawColorPieChart(chartData) {

                var sliceColors = [];
                chartData.forEach(function (e) {
                    sliceColors.push(getChartColor(e[0]));
                });

                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Color');
                data.addColumn('number', 'Number');
                data.addRows(chartData);

                var options = {
                    // title: "Color Distribution",
                    height: 240,
                    colors: sliceColors,
                    pieSliceText: 'value',
                    pieSliceBorderColor: "black",
                    pieSliceTextStyle: {
                        color: 'darkslategrey',
                        bold: true
                    },
                    // chartArea: {
                    //     width: '100%',
                    //     height: '80%'
                    // },
                    backgroundColor: {
                        fill: 'transparent'
                    },
                    legend: {
                        textStyle: {
                            color: 'black'
                        }
                    },
                };

                var chart = new google.visualization.PieChart(document.getElementById(colorPieChartId));
                chart.draw(data, options);
            }

            function MakeLabelsForManaCurve(chartData) {
                var labels = ['Cost'];
                var k = 0;
                while (k < chartData.length) {
                    var color = chartData[k++][colorIndex];
                    labels.push(color);
                    while (k < chartData.length && chartData[k][colorIndex] === color)
                        ++k;
                }
                return labels;
            }

            function formatDataForManaCurveChart(chartData) {
                var labels = MakeLabelsForManaCurve(chartData);
                var numColumns = labels.length;

                var data = [labels];
                for (var k = 0; k < 7; k++) {
                    var dataline = new Array(numColumns);
                    dataline[0] = k.toString();
                    for (var k2 = 1; k2 < numColumns; k2++)
                        dataline[k2] = 0;
                    data.push(dataline);
                }
                data[7][0] = "6+";

                var index = 1;
                var color = chartData[0][colorIndex];
                chartData.forEach(function (row) {
                    if (color != row[colorIndex]) {
                        ++index;
                        color = row[colorIndex];
                    }
                    var cmc = Math.min(row[cmcIndex], 6);
                    data[cmc + 1][index] += row[numIndex];
                });

                for (var seriesIndex = 1; seriesIndex < data.length; seriesIndex++) {
                    series = data[seriesIndex];
                    for (var itemIndex = 1; itemIndex < series.length; itemIndex++) {
                        if (series[itemIndex] === 0)
                            series[itemIndex] = null;
                    }
                }

                return data;
            }


            function drawManaCurveChart(chartData) {

                var adjustedChartData = formatDataForManaCurveChart(chartData);
                var data = google.visualization.arrayToDataTable(adjustedChartData);

                var sectionColors = [];
                for (var k = 1; k < adjustedChartData[0].length; k++)
                    sectionColors.push(getChartColor(adjustedChartData[0][k]));

                var options = {
                    //width: 600,
                    //height: 400,
                    legend: {
                        position: 'top',
                        maxLines: 3
                    },
                    bar: {
                        groupWidth: '80%'
                    },
                    isStacked: true,
                    backgroundColor: {
                        fill: 'transparent'
                    },
                    animation: {
                        duration: 500,
                        startup: true,
                    },
                    // chartArea: {
                    //     width: '100%',
                    //     height: '80%'
                    // },
                    colors: sectionColors,
                };

                var chart = new google.visualization.ColumnChart(document.getElementById(manaCurveChartId));
                chart.draw(data, options);
            }

            function colorPieChart(cardData) {
                var rawData = getColorOnlyData(cardData);
                var summedData = sumByColor(rawData);
                drawColorPieChart(summedData);
            }

            function manaCurveChart(cardData) {
                var rawData = getColorWithCostData(cardData);
                var summedData = sumByColorAndCost(rawData);
                drawManaCurveChart(summedData);
            }

            function drawAllCharts(chartData) {
                if (hasColorPieChart())
                    colorPieChart(chartData);
                if (hasManaCurveChart())
                    manaCurveChart(chartData);
            }

            function chartLibraryLoaded() {
                var chartData = getChartData();
                drawAllCharts(chartData);
                $(window).resize(function () {
                    drawAllCharts(chartData);
                });
            }

            // do nothing for a page with no charts
            if (!hasCharts())
                return;

            jQuery.getScript('https://www.gstatic.com/charts/loader.js', function () {
                google.charts.load('current', { 'packages': ['corechart'] });
                google.charts.setOnLoadCallback(chartLibraryLoaded);
            });

        })();
        // End: graphs



    </script>
</body>
</html>